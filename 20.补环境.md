# 补环境系列



### 一.环境检测

#### 1. 什么是环境检测

- 由于浏览器和node的差别,会导致浏览器的js代码在node没有办法执行,js代码会根据浏览器的这些属性来判断你是不是在真正的浏览器执行的代码,要不是正确的浏览器环境则不会返回正确的数据信息.
- 拿到代码在node里面执行、经常看到这一类型的错误，提示xxx未定义，其实这一块就是浏览器对象的一些特征

```javascript
 if (navigator['userAgent']){
    ^

ReferenceError: navigator is not defined
```

#### 2.案例讲解

- 检测执行代码是否存在`navigator`, 可以通过补空的方式

```javascript

navigator = {}
navigator.userAgent = '11111'

function ps(){
    if (navigator['userAgent']){
        return 'hello world'
    } else {
        return  '失败'
    }
}

console.log(ps());

```

- 检测属性长度,会根据长度来判断你的数据是否正确,是不是一个空数据

```javascript

location = {}
location.href = '123123'
function ps(){
    if (location['href'].length > 3){
        return 'hello world'
    } else {
        return  '失败'
    }
}

console.log(ps());
```

- js异常代码捕获,很多情况下可能js代码会把异常给捕获掉导致我们结果不对
- 可以输出异常捕获的内容, 或者可以直接把异常捕获的代码直接删除,把错误暴露出来

```javascript
location = {}
location.host = '12334'
navigator = {}
navigator.userAgent = '1231234'
function pn() {
    // try {
        verify_local()
        if (navigator['userAgent']) {
            return 'hello world'
        }
    // } catch (e) {
    //     console.log(e)
    //     return '错误的数据'
    // }
}

function verify_local() {
    if (location.host.length > 2) {
        return 'xxx'
    }
}

console.log(pn());
```

- 浏览器和node环境差异
- 在 Node.js 中，`exports` 是一个用于导出模块中的函数、对象、变量等的对象。
- 浏览器是undefined
- 可以删除, 或者可以修改的判断成功

```javascript
// 浏览器和 node差异
sss = "undefined" != typeof exports ? exports : void 0
console.log(typeof sss);
```

- global检测

```javascript
glb= "undefined" == typeof window ? global:window
```



### 二 .吐环境脚本

#### 1. 简介

`Proxy`可以理解为，在目标对象之前设一层"拦截"，外界对该对象的访问，都必须通过这层拦截,可以对外界的访问进行过滤和改写（表示可以用它"代理"某些操作，可以翻为“代理器"）。

api地址: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy

![img](https://upload-images.jianshu.io/upload_images/6662793-b2337b464c5bcb7f.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

Proxy对象由两个部分组成：target、handler

target:目标对象
handler：是一个对象，声明了代理target的指定行为，支持的拦截操作，一共13种：

- `get(target,propKey,receiver)`：拦截对象属性的读取。
  - `target`: 目标对象
  - `propKey`: 被获取的属性名。
  - `receiver`: Proxy 或者继承 Proxy 的对象
- `set(target,propKey,value,receiver)`：拦截对象属性的设置，返回一个布尔值（修改成功）。
  - `target`: 目标对象
  - `propKey `: 被获取的属性名。
  - `value`: 新属性值。
  - `receiver`: Proxy 或者继承 Proxy 的对象

一般的补环境的是通过运行程序后的undefined报错去一点一点分析，一点一点的去补一些环境，是非常掉头发的。

所以我们使用 Proxy 对全局遍历window、document、navigator等常见环境检测点进行代理，拦截代理对象的读取、函数调用等操作，并通过控制台输出，这样的话我们就能够实现检测环境自吐的功能，后续我们再针对吐出来的环境统一的进行补环境，这样就会方便的多。

#### 2. 基础使用方法

```JavaScript
var target = {
    name: 'JACK',
    age: 18,
};

var p = new Proxy(target, {

    get: function (target, propertyKey, receiver) {
        // 1 原对象
        // 2 访问属性
        // 3 代理器处理对象
        console.log(target, propertyKey, receiver)
    },
    set: function(target,propertyKey,value,receiver){
        // 1. 原对象
        // 2. 设置的属性
        // 3. 设置的值
        // 4. 代理器代理的对象
        console.log(target, propertyKey, value, receiver)
    }
})
p.age
p.user = 'aa'
```

**注意**:

> 我们现在写的代码,已经能够去拦截到取值和设置的操作,但是这个代码会打乱代码的后续运行,还并没有把对应的操作作用在原对象上,怎么解决呢?

#### 3.数据返回

```javascript
Reflect.get(target, propertyKey, receiver); //查找并返回target对象的name属性，receiver绑定this
Reflect.set(target, propertyKey, value, receiver); //设置target对象的name属性等于value
```

`Reflect.set(target, name, value, receiver)` 是 JavaScript 中的 Reflect 对象的一个方法。它用于设置指定对象的属性值，并返回一个布尔值，表示设置是否成功。

参数的含义如下：

- `target`：要设置属性值的目标对象。
- `propertyKey`：要设置的属性名。
- `value`：要设置的属性值。
- `receiver`（可选）：设置属性时绑定的 `this` 值。



#### 4. 完整代理使用

```javascript
var target = {
    name: 'JACK',
    age: 18,
};

var p = new Proxy(target, {

    get: function (target, propertyKey, receiver) {
        temp = Reflect.get(target, propertyKey, receiver); //查找并返回target对象的name属性，receiver绑定this
        // 1 原对象
        // 2 访问属性
        // 3 代理器处理对象
        // console.log(target, propertyKey, receiver)
        console.log(`对象${target}--> get了属性--> ${propertyKey} 值是--> ${temp}`);
        return temp
    },
    set: function(target,p,value,receiver){
        temp = Reflect.set(target, p, value, receiver);
        // 1. 原对象
        // 2. 设置的属性
        // 3. 设置的值
        // 4. 代理器代理的对象
        // console.log(target, propertyKey, value, receiver)
        console.log("set: ", target, p, target[p]);
        return temp
    }
})
// console.log(p.age);
p.user = 'aa'
console.log(p.user)

```

#### 5. 代理封装

```JavaScript
// 目标对象（被代理对象）
var target = {
    name: 'JACK',
    age: 18,
    lili:{
        zs:'nana'
        
    }
};

function XlProxy(obj,name){
    return new Proxy(obj,{
        get(target, p, receiver) {
            temp = Reflect.get(target,p,receiver)
            console.log(`对象${name}--> get了属性--> ${p} 值是--> ${temp}`);
            if (typeof temp == 'object'){
                 // 对于对象套对象进行挂代理
                 temp = XlProxy(temp,name + '-->' + p)
            }
            return temp
        }
    })
}
sss = XlProxy(target,'target')
sss.name
sss.lili.zs
```



#### 6. 封装所有使用方法

```JavaScript
// 代理器封装
function get_enviroment(proxy_array) {
    for(var i=0; i<proxy_array.length; i++){
        handler = '{\n' +
            '    get: function(target, property, receiver) {\n' +
            '        console.log("方法:", "get  ", "对象:", ' +
            '"' + proxy_array[i] + '" ,' +
            '"  属性:", property, ' +
            '"  属性类型:", ' + 'typeof property, ' +
            // '"  属性值:", ' + 'target[property], ' +
            '"  属性值类型:", typeof target[property]);\n' +
            '        return target[property];\n' +
            '    },\n' +
            '    set: function(target, property, value, receiver) {\n' +
            '        console.log("方法:", "set  ", "对象:", ' +
            '"' + proxy_array[i] + '" ,' +
            '"  属性:", property, ' +
            '"  属性类型:", ' + 'typeof property, ' +
            // '"  属性值:", ' + 'target[property], ' +
            '"  属性值类型:", typeof target[property]);\n' +
            '        return Reflect.set(...arguments);\n' +
            '    }\n' +
            '}'
        eval('try{\n' + proxy_array[i] + ';\n'
        + proxy_array[i] + '=new Proxy(' + proxy_array[i] + ', ' + handler + ')}catch (e) {\n' + proxy_array[i] + '={};\n'
        + proxy_array[i] + '=new Proxy(' + proxy_array[i] + ', ' + handler + ')}')
    }
}
proxy_array = ['window', 'document', 'location', 'navigator', 'history','screen']
get_enviroment(proxy_array)
```



#### 7.吐环境实战案例

##### 1. 逆向目标

- 地址：https://q.10jqka.com.cn/
- 参数：v

##### 2. 逆向结果

```javascript
// 代理器封装
function get_enviroment(proxy_array) {
    for(var i=0; i<proxy_array.length; i++){
        handler = '{\n' +
            '    get: function(target, property, receiver) {\n' +
            '        console.log("方法:", "get  ", "对象:", ' +
            '"' + proxy_array[i] + '" ,' +
            '"  属性:", property, ' +
            '"  属性类型:", ' + 'typeof property, ' +
            // '"  属性值:", ' + 'target[property], ' +
            '"  属性值类型:", typeof target[property]);\n' +
            '        return target[property];\n' +
            '    },\n' +
            '    set: function(target, property, value, receiver) {\n' +
            '        console.log("方法:", "set  ", "对象:", ' +
            '"' + proxy_array[i] + '" ,' +
            '"  属性:", property, ' +
            '"  属性类型:", ' + 'typeof property, ' +
            // '"  属性值:", ' + 'target[property], ' +
            '"  属性值类型:", typeof target[property]);\n' +
            '        return Reflect.set(...arguments);\n' +
            '    }\n' +
            '}'
        eval('try{\n' + proxy_array[i] + ';\n'
        + proxy_array[i] + '=new Proxy(' + proxy_array[i] + ', ' + handler + ')}catch (e) {\n' + proxy_array[i] + '={};\n'
        + proxy_array[i] + '=new Proxy(' + proxy_array[i] + ', ' + handler + ')}')
    }
}
proxy_array = ['window', 'document', 'location', 'navigator', 'history','screen']

window = global;
window.addEventListener = function(args){
    console.log('window的addEventListener:', args)
}

document = {
    head: {},
    createElement: function (args) {
        console.log('document的createElement:', args)
        if (args == 'div'){
            return {}
        }

    },
    addEventListener: function (args) {
        console.log('document的addEventListener:', args)
    },
    // documentElement: function (args) {
    //     console.log('document的documentElement:', args)
    // }
}

// navigator = {
//     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36'
// }

get_enviroment(proxy_array)


            n[e[57]] = P;
            function D() {
                return O()
            }
            window.aaaa = D;
            n[v(an, a[198], r[199])] = D


function aaa() {
    console.log(window.aaaa());
    // console.log(document.cookie);
}
aaa()

```



### 三.Selenium补环境

#### 1. 简介

`Selenium`就是一个真实的环境地址,对于我们拿下来的js代码,在node是需要补环境的,但是在浏览器去执行的话,他就是一个真实的浏览器环境,所以可以节省我们扣代码的时间,我们可以把扣下来的代码直接用Selenium来进行访问

#### 2.实战案例

##### 1. 逆向目标

- 网址:https://q.10jqka.com.cn/
- 参数:cookie :v

##### 2. 实现代码

- 我们把同花顺的js代码直接放到html文件

- python代码

```python

import os
from selenium import webdriver

PRO_DIR = os.path.dirname(os.path.abspath(__file__))
def driver_sig(html_file):
    option = webdriver.ChromeOptions()
    option.add_argument('--disable-blink-features=AutomationControlled')
    option.add_argument('headless')
    driver = webdriver.Chrome(options=option)
    driver.get(PRO_DIR +'\\'+ html_file)
    # time.sleep(2)
    # sig = driver.execute_script('return window.aaa()')
    # print(sig)
    return driver

html_file = 'index.html'
driv = driver_sig(html_file)

print(driv.execute_script('return window.aaa()'))

```

#### 3.实现接口

```python
pip install flask
from flask import Flask

# 创建 Flask 应用实例
app = Flask(__name__)

# 定义路由和视图函数
@app.route('/')
def hello():
    return 'Hello, Flask!'

# 启动应用
if __name__ == '__main__':
    app.run()
```

- Flask 是一个基于 Python 的轻量级、简单易用的 Web 应用框架。它提供了一个灵活且容易扩展的方式来构建 Web 应用程序。以下是一个简单的示例展示了如何使用 Flask 框架创建一个简易的 Web 应用：

- 在上述示例中，我们首先导入了 Flask 模块，并创建了一个 Flask 应用实例 `app`。然后，使用 `@app.route()` 装饰器定义了一个路由以及对应的视图函数。在本例中，根路由 `'/'` 对应的视图函数是 `hello()`，它返回了一个简单的字符串 `'Hello, Flask!'`。最后，通过调用 `app.run()` 来启动应用。

- 要运行这个应用，你需要确保已经安装了 Flask 模块。运行应用后，在浏览器中访问 `http://localhost:5000/`，你将看到输出的 `'Hello, Flask!'`。

##### 1.实际使用

```python
# -*- coding: utf-8 -*-

from flask import Flask, request

from selenium import webdriver
import os
from selenium.webdriver.common.by import By
# pip install flask
from flask import Flask, jsonify

PRO_DIR = os.path.dirname(os.path.abspath(__file__))


def driver_sig(html_file):
    option = webdriver.ChromeOptions()
    option.add_argument('--disable-blink-features=AutomationControlled')
    option.add_argument('headless')
    driver = webdriver.Chrome(options=option)
    driver.get(PRO_DIR + '\\' + html_file)
    # time.sleep(2)
    # sig = driver.execute_script('return window.aaa()')
    # print(sig)
    return driver


html_file = 'index.html'
driv = driver_sig(html_file)

# 创建 Flask 应用实例
app = Flask(__name__)


# 定义路由和视图函数
@app.route('/s', methods=['get', 'post'])
def hello():
    context = {
        # 加载本地地址 生成cookie值
        'v': driv.execute_script('return window.aaa()')
    }
    # 返回cookie值
    return jsonify(context=context)



# 启动应用
if __name__ == '__main__':
    app.run()

```



### 四.jsdom补环境

参考地址：https://github.com/jsdom/jsdom/wiki/jsdom-中文文档

`jsdom`是一个纯粹由 `javascript` 实现的一系列 web标准，特别是 WHATWG 组织制定的[DOM](https://dom.spec.whatwg.org/)和 [HTML](https://html.spec.whatwg.org/multipage/) 标准，用于在` nodejs `中使用。大体上来说，该项目的目标是模拟足够的Web浏览器子集，以便用于测试和挖掘真实世界的Web应用程序

#### 1. 环境安装 

```bash
npm install jsdom --save
```

#### 2. 基本使用

```javascript
const jsdom = require("jsdom");
const { JSDOM } = jsdom;
const dom = new JSDOM(`<!DOCTYPE html><p>Hello world</p>`);
title = dom.window.document.querySelector("p").textContent
console.log(title)
```

#### 3. 添加参数形式

```javascript
const dom = new JSDOM(``, {
  url: "http://q.10jqka.com.cn/",
  referrer: "http://q.10jqka.com.cn/",
  contentType: "text/html",
  includeNodeLocations: true,
  storageQuota: 10000000
});
```





### 五.了解jsvmp技术

#### 1. js虚拟机保护方案

参考文章：https://mp.weixin.qq.com/s/YDx5Dr-HDfAm-sAqeWW0qg

- JSVMP 的概念最早应该是由西北大学2015级硕士研究生匡开圆，在其2018年的学位论文中提出的，论文标题为：《基于 WebAssembly 的 JavaScript 代码虚拟化保护方法研究与实现》，同年还申请了国家专利，专利名称：《一种基于前端字节码技术的 JavaScript 虚拟化保护方法》，网上可以直接搜到
- 常见的jsvmp的实现方法，你可以理解为：就是自己写了一段代码解释器，用来解释自己的代码        而这个自己的代码：可以是密文，也可以是所谓的明文

#### 2.jsvmp实现原理

- JSVMP 的核心是在 JavaScript 代码保护过程中引入代码虚拟化思想，实现源代码的虚拟化过程，将目标代码转换成自定义的字节码，这些字节码只有特殊的解释器才能识别，隐藏目标代码的关键逻辑。在匡开圆的论文中，利用 WebAssembly 技术实现了特殊的虚拟解释器，通过编译隐藏解释器的执行逻辑。JSVMP 的保护流程如下图所示：

![](D:/%E5%9B%BE%E7%81%B5%E8%AF%BE%E7%A8%8B%E5%AE%89%E6%8E%92/%E7%88%AC%E8%99%ABvip%E7%8F%AD%E7%BA%A7/%E7%88%AC%E8%99%ABvip%E8%AF%BE%E4%BB%B6/js%E9%80%86%E5%90%91%E8%AF%BE%E4%BB%B6/images/080.png)

- 大致的架构应该是这样子的：服务器端读取 JavaScript 代码 —> 词法分析 —> 语法分析 —> 生成AST语法树 —> 生成私有指令 —> 生成对应私有解释器，将私有指令加密与私有解释器发送给浏览器，然后一边解释，一边执行。

#### 3. 模拟jsvmp执行过程

- 准备数据

```javascript
var a = '丽丽'
var b = '菲菲'
var c = '莹莹'
var d = a+b
var e = c + d
```

- 将数据进行第一次转换

```javascript
var a ;
a = '丽丽'
var b;
b = '菲菲'
var c;
c = '莹莹'
var d;
a+b;
d = ?;
var e;
c+d;
e = ?;
```

- 再次转换

```javascript
// 我们假设赋值指令为 1, 加和指令为 2,声明指令为 3
// 如果按照从上到下的顺序，我们就可以将他们的操作变成指令性的[用|分割左侧和右侧]
// 1 赋值
// 2 加
// 3 声明

3 --- var | a
1 --- a |  '丽丽'
3 --- var | b
1 --- b |  '菲菲'
3 --- var | c
1 --- c |  '莹莹'
3 --- var | d
2 --- a | b  -----> ?
1 --- d | ?
3 --- var | e
2 --- d | c   -----> ?
1 --- e | ?(此处的d 与 c的和)
```

- 在将数据压缩到数组

```javascript
_stack = [
            [3, 'var', 'a'],
            [1, 'a', '丽丽'],
            [3, 'var', 'b'],
            [1, 'b', '菲菲'],
            [3, 'var', 'c'],
            [1, 'c', '莹莹'],
            [3, 'var', 'd'],
            [2, 'a', 'b'],
            [1, 'd', '?'],
            [3, 'var', 'e'],
            [2, 'd', 'c'],
            [1, 'e', '?'],
        ]
```

- 通过自己写的自执行函数,对数据进行处理

```javascript
!function(_stack) {
    var register;   // 这个就当做是问号的存储位置
    var variable = {};   // 这个就当做是var变量的存储位置。由于没有其他声明方式的存在，所就不写其他的了
    for (let i = 0; i < _stack.length; i++) {
        instruct = _stack[i][0];
        left = _stack[i][1];
        right = _stack[i][2];
        if (instruct === 3) {
            variable[right] = ''
        }
        if (instruct === 1) {
            if (right === '?') {
                variable[left] = register
            } else {
                variable[left] = right
            }
        }
        if (instruct === 2) {
            register = variable[left] + variable[right]
        }
    };
    console.log(variable)
} ([
            [3, 'var', 'a'],
            [1, 'a', '丽丽'],
            [3, 'var', 'b'],
            [1, 'b', '菲菲'],
            [3, 'var', 'c'],
            [1, 'c', '莹莹'],
            [3, 'var', 'd'],
            [2, 'a', 'b'],
            [1, 'd', '?'],
            [3, 'var', 'e'],
            [2, 'd', 'c'],
            [1, 'e', '?'],
        ]
)

```

- 实际jsvmp会更加的复杂,这个是基本的逻辑,就行自己写一个解释器来解释自己的代码

关于jsvmp的解法一般有3种，`补环境，和插桩扣逻辑，jsrpc`，当然还有自动化等方式可自行研究试试





### 六. 项目实战

#### 1. 案例

##### 1. 逆向目标

- 目标网址:https://www.douyin.com/user/MS4wLjABAAAAyGi6PcV0GZZRrjzymBW6N942bvw1A-rT5RWuc5rHTwg?vid=7347993775496629542
- 解析参数:a_bogus

##### 2.逆向分析

- 通过xhr定位加密位置
- xhr定位数据在xhr之前,我们需要跟栈找数据位置
- 定位的位置在上一个栈    

![image-20250106181714487](.\image\image-20250106181714487.png)



- 可以通过日志调试查看数据信息
- 通过条件断点,准确定位到那一次信息

![image-20250106181957805](.\image\image-20250106181957805.png)

- 进去之后就是单独的自执行方法为jsvmp方法



##### 3.逆向结果

- JavaScript代码

```javascript
// 代理器封装
function get_enviroment(proxy_array) {
    for (var i = 0; i < proxy_array.length; i++) {
        handler = '{\n' +
            '    get: function(target, property, receiver) {\n' +
            '        console.log("方法:", "get  ", "对象:", ' +
            '"' + proxy_array[i] + '" ,' +
            '"  属性:", property, ' +
            '"  属性类型:", ' + 'typeof property, ' +
            // '"  属性值:", ' + 'target[property], ' +
            '"  属性值类型:", typeof target[property]);\n' +
            '        return target[property];\n' +
            '    },\n' +
            '    set: function(target, property, value, receiver) {\n' +
            '        console.log("方法:", "set  ", "对象:", ' +
            '"' + proxy_array[i] + '" ,' +
            '"  属性:", property, ' +
            '"  属性类型:", ' + 'typeof property, ' +
            // '"  属性值:", ' + 'target[property], ' +
            '"  属性值类型:", typeof target[property]);\n' +
            '        return Reflect.set(...arguments);\n' +
            '    }\n' +
            '}'
        eval('try{\n' + proxy_array[i] + ';\n'
            + proxy_array[i] + '=new Proxy(' + proxy_array[i] + ', ' + handler + ')}catch (e) {\n' + proxy_array[i] + '={};\n'
            + proxy_array[i] + '=new Proxy(' + proxy_array[i] + ', ' + handler + ')}')
    }
}

proxy_array = ['window', 'document', 'location', 'navigator', 'history', 'screen']

window = global
window.requestAnimationFrame = function (args) {
    console.log('window的requestAnimationFrame参数', args)
}
window._sdkGlueVersionMap = {
    "sdkGlueVersion": "1.0.0.51",
    "bdmsVersion": "1.0.1.5",
    "captchaVersion": "4.0.2"
}

XMLHttpRequest = function (args) {
    console.log('XMLHttpRequest', args)
}

document = {
    createElement: function (arg) {

        console.log('document的createElement参数', arg)
        if (arg == 'span') {
            return {}
        }
    },
    documentElement: function (arg) {
        console.log('document的documentElement参数', arg)
    },
    createEvent: function (arg) {
        console.log('document的createEvent参数', arg)
    },
    all: []
}


navigator = {
    userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36'

}

get_enviroment(proxy_array)


!function () {


    function e(r, t, n, a, f) {
        var c, s, u, b, l, d = -1, p = [], h = null, v = [t];
        for (s = Math.min(t.length, n),
                 u = 0; u < s; ++u)
            v.push(t[u]);
        v.p = a;
        for (var g = []; ;)
            try {
                var m = i[r++];
                if (m < 37)
                    if (m < 18)
                        if (m < 7)
                            m < 3 ? p[++d] = m < 1 || 1 !== m && null : m < 4 ? (c = i[r++],
                                p[++d] = c << 24 >> 24) : 4 === m ? (c = (i[r] << 8) + i[r + 1],
                                r += 2,
                                p[++d] = c << 16 >> 16) : (c = ((c = ((c = i[r++]) << 8) + i[r++]) << 8) + i[r++],
                                p[++d] = (c << 8) + i[r++]);
                        else if (m < 13)
                            m < 8 ? (c = (i[r] << 8) + i[r + 1],
                                r += 2,
                                p[++d] = o[c]) : 8 === m ? p[++d] = void 0 : (c = (i[r] << 8) + i[r + 1],
                                r += 2,
                                d = d - c + 1,
                                s = p.slice(d, d + c),
                                p[d] = s);
                        else if (m < 14)
                            p[++d] = {};
                        else if (14 === m)
                            c = (i[r] << 8) + i[r + 1],
                                r += 2,
                                s = o[c],
                                u = p[d--],
                                p[d][s] = u;
                        else {
                            for (s = i[r++],
                                     u = i[r++],
                                     b = v; s > 0; --s)
                                b = b.p;
                            p[++d] = b[u]
                        }
                    else if (m < 26)
                        if (m < 22)
                            if (m < 19)
                                c = (i[r] << 8) + i[r + 1],
                                    r += 2,
                                    s = o[c],
                                    p[d] = p[d][s];
                            else if (19 === m)
                                s = p[d--],
                                    p[d] = p[d][s];
                            else {
                                for (s = i[r++],
                                         u = i[r++],
                                         b = v; s > 0; --s)
                                    b = b.p;
                                b[u] = p[d--]
                            }
                        else if (m < 23)
                            s = p[d--],
                                u = p[d--],
                                b = p[d--],
                                u[s] = b;
                        else if (23 === m) {
                            for (s = i[r++],
                                     u = i[r++],
                                     b = v,
                                     b = v; s > 0; --s)
                                b = b.p;
                            p[++d] = b,
                                p[++d] = u
                        } else
                            s = p[d--],
                                p[d] += s;
                    else
                        m < 29 ? m < 27 ? (s = p[d--],
                            p[d] *= s) : 27 === m ? (s = p[d--],
                            p[d] /= s) : (s = p[d--],
                            p[d] %= s) : m < 35 ? 29 === m ? p[d] = -p[d] : (s = p[d--],
                            b = (u = p[d--])[s]++,
                            p[++d] = b) : 35 === m ? (s = p[d--],
                            p[d] = p[d] == s) : (s = p[d--],
                            p[d] = p[d] != s);
                else if (m < 53)
                    m < 47 ? m < 41 ? m < 38 ? (s = p[d--],
                        p[d] = p[d] === s) : 38 === m ? (s = p[d--],
                        p[d] = p[d] !== s) : (s = p[d--],
                        p[d] = p[d] < s) : m < 44 ? (s = p[d--],
                        p[d] = p[d] > s) : 44 === m ? (s = p[d--],
                        p[d] = p[d] >> s) : (s = p[d--],
                        p[d] = p[d] & s) : m < 50 ? m < 48 ? (s = p[d--],
                        p[d] = p[d] | s) : 48 === m ? p[d] = ~p[d] : (s = p[d--],
                        p[d] = p[d] ^ s) : m < 51 ? p[d] = !p[d] : 51 === m ? (c = (c = (i[r] << 8) + i[r + 1]) << 16 >> 16,
                        r += 2,
                        p[d] ? --d : r += c) : (c = (c = (i[r] << 8) + i[r + 1]) << 16 >> 16,
                        r += 2,
                        p[d] ? r += c : --d);
                else if (m < 66)
                    if (m < 58)
                        m < 54 ? (s = p[d--],
                            (u = p[d--])[s] = p[d]) : 54 === m ? (s = p[d--],
                            p[d] = p[d] in s) : p[d] = void 0;
                    else if (m < 59)
                        p[d] = typeof p[d];
                    else {
                        if (59 !== m)
                            throw s = p[d--];
                        c = i[r++],
                            s = p[d--],
                            (u = function e() {
                                    var r = e._v;
                                    return (0,
                                        e._u)(r[0], arguments, r[1], r[2], this)
                                }
                            )._v = [s, c, v],
                            u._u = e,
                            p[++d] = u,
                            window._U = u
                    }
                else if (m < 69)
                    if (m < 67) {
                        for (s = p[d--],
                                 u = null; b = g.pop();)
                            if (2 === b[0] || 3 === b[0]) {
                                u = b;
                                break
                            }
                        if (u)
                            r = u[2],
                                u[0] = 0,
                                g.push(u);
                        else {
                            if (!h)
                                return s;
                            r = h[1],
                                f = h[2],
                                v = h[3],
                                g = h[4],
                                p[++d] = s,
                                h = h[0]
                        }
                    } else if (67 === m)
                        d -= c = i[r++],
                            u = p.slice(d + 1, d + c + 1),
                            s = p[d--],
                            b = p[d--],
                            s._u === e ? (s = s._v,
                                h = [h, r, f, v, g],
                                r = s[0],
                            null == b && (b = function () {
                                return this
                            }()),
                                f = b,
                                (v = [u].concat(u)).length = Math.min(s[1], c) + 1,
                                v.p = s[2],
                                g = []) : (l = s.apply(b, u),
                                p[++d] = l);
                    else {
                        for (c = i[r++],
                                 b = [void 0],
                                 l = c; l > 0; --l)
                            b[l] = p[d--];
                        u = p[d--],
                            l = new (s = Function.bind.apply(u, b)),
                            p[++d] = l
                    }
                else
                    m < 73 ? 69 === m ? r += 2 + (c = (c = (i[r] << 8) + i[r + 1]) << 16 >> 16) : (c = (c = (i[r] << 8) + i[r + 1]) << 16 >> 16,
                        r += 2,
                    (s = p[d--]) || (r += c)) : 73 === m ? --d : (s = p[d],
                        p[++d] = s)
            } catch (e) {
                for (; (c = g.pop()) && !c[0];)
                    ;
                if (!c) {
                    e: for (; h;) {
                        for (s = h[4]; c = s.pop();)
                            if (c[0])
                                break e;
                        h = h[0]
                    }
                    if (!h)
                        throw e;
                    r = h[1],
                        f = h[2],
                        v = h[3],
                        g = h[4],
                        h = h[0]
                }
                1 === (s = c[0]) ? (r = c[2],
                    c[0] = 0,
                    g.push(c),
                    p[++d] = e) : 2 === s ? (r = c[2],
                    c[0] = 0,
                    g.push(c)) : (r = c[3],
                    c[0] = 2,
                    g.push(c),
                    p[++d] = e)
            }
    }

    (u, [], 0, r, t)


}();


function get_a_bogus(arg) {
    var r = window._U._v;
    console.log(r)
    return window._U._u(r[0], arg, r[1], r[2], null)
}


function get_ab(arguments) {

    arg = [
        0,
        1,
        0,
        arguments,
        "",
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"
    ]
    var data = get_a_bogus(arg)
    return data
}


// arg = 'device_platform=webapp&aid=6383&channel=channel_pc_web&sec_user_id=MS4wLjABAAAAyGi6PcV0GZZRrjzymBW6N942bvw1A-rT5RWuc5rHTwg&max_cursor=1709713733000&locate_item_id=7347993775496629542&locate_query=false&show_live_replay_strategy=1&need_time_list=0&time_list_query=0&whale_cut_token=&cut_version=1&count=18&publish_video_strategy_type=2&update_version_code=170400&pc_client_type=1&version_code=290100&version_name=29.1.0&cookie_enabled=true&screen_width=1536&screen_height=864&browser_language=zh-CN&browser_platform=Win32&browser_name=Chrome&browser_version=124.0.0.0&browser_online=true&engine_name=Blink&engine_version=124.0.0.0&os_name=Windows&os_version=10&cpu_core_num=16&device_memory=8&platform=PC&downlink=10&effective_type=4g&round_trip_time=100&webid=7367233937146922550'
//
// data = get_ab(arg)
// console.log(data, data.length)

```

- python

```python
import requests
import execjs
from loguru import logger
from concurrent.futures import ThreadPoolExecutor
import os

requests = requests.session()
# typeof R == 'string' &&  R.length > 100

class Dy_vido:
    def __init__(self):
        # self.url_search = "https://www.douyin.com/aweme/v1/web/general/search/single/"
        self.url_api = "https://www.toutiao.com/api/pc/list/feed"
        self.headers = {
            "accept": "application/json, text/plain, */*",
            "accept-language": "zh-CN,zh;q=0.9",
            "cache-control": "no-cache",
            "pragma": "no-cache",
            "priority": "u=1, i",
            "referer": "https://www.douyin.com/user/MS4wLjABAAAAldrNlnQQf3JhlLukKhaL9iqca0V6Gkj15x_n6SL8I1UOjnfumyxnX4f5qCRAX_KP",
            "sec-ch-ua": "\"Chromium\";v=\"124\", \"Google Chrome\";v=\"124\", \"Not-A.Brand\";v=\"99\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "same-origin",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36",
            'cookie': 'bd_ticket_guard_client_web_domain=2; ttwid=1%7C8VOQw4YGKyWTBxqOwhsoAiCf37-V6XW86z4MwUExNnU%7C1718343526%7Cd8a9664c832134d5bd73aa79eee7ea1732fd6afa834785c6c820aaf61522966a; __ac_nonce=0669f701f00491a4bfe98; __ac_signature=_02B4Z6wo00f01wjApCQAAIDC1Lk7ks62i9MI4KCAAKS510; UIFID_TEMP=3c3e9d4a635845249e00419877a3730e2149197a63ddb1d8525033ea2b3354c240cb58adefac8243cf4b244d0fdbdd08743c5e47bd12c5dc46a258fef47d268ffdef966ac88d2d298678086248caf9bb; dy_swidth=1536; dy_sheight=864; stream_recommend_feed_params=%22%7B%5C%22cookie_enabled%5C%22%3Atrue%2C%5C%22screen_width%5C%22%3A1536%2C%5C%22screen_height%5C%22%3A864%2C%5C%22browser_online%5C%22%3Atrue%2C%5C%22cpu_core_num%5C%22%3A16%2C%5C%22device_memory%5C%22%3A8%2C%5C%22downlink%5C%22%3A1.3%2C%5C%22effective_type%5C%22%3A%5C%223g%5C%22%2C%5C%22round_trip_time%5C%22%3A250%7D%22; csrf_session_id=ba459953619ee561c259fdc3efa38509; fpk1=U2FsdGVkX18rNhQcPOd4Zji3SnvEI3te5rdBPiswNon8sZ00aXpH/t/ry0tH4fy7Ic++X8htM9VZ+O//BEX5fA==; fpk2=f1f6b29a6cc1f79a0fea05b885aa33d0; strategyABtestKey=%221721724963.273%22; s_v_web_id=verify_lyy6l86i_gmgyZ5NB_SXeG_4k81_9RFx_5ChmiFcLJ6fr; passport_csrf_token=8b149de0645b48976402aedd43cf71c9; passport_csrf_token_default=8b149de0645b48976402aedd43cf71c9; FORCE_LOGIN=%7B%22videoConsumedRemainSeconds%22%3A180%7D; passport_assist_user=CkHhgqHGcuqnNr4Jp2DVYFMyCrtdoNM9A5ALxVe_TIRbUzq6T3dLCSYbQHpFKTqUftYVsIciJxqWrd0hCjkdIexdIhpKCjzvo-kGAnuDylQgLhpCVyeCuycr9poNA_TlMZhZvoJdkqgTdVBLlnMA-sTxpkhV6bCaPw-Nn09bsgiVeUAQ_7TXDRiJr9ZUIAEiAQOcykRX; n_mh=_hjMo0XeYAL0xHOj-0NKgwD0Gpufc99xoEXxoEB_q_E; sso_uid_tt=29ab3cb45366b6a1bf9297b3f3a44e6e; sso_uid_tt_ss=29ab3cb45366b6a1bf9297b3f3a44e6e; toutiao_sso_user=2392aa0f13fd94cfd6a400741194b124; toutiao_sso_user_ss=2392aa0f13fd94cfd6a400741194b124; sid_ucp_sso_v1=1.0.0-KDRiY2EzOTI1NzUwNjE5MDJkZWRiNzdlMTVhMmE2M2EyNzRmNzgxOTcKIQi8rrCOmPW7BhCv4P20BhjvMSAMMI7P4PwFOAZA9AdIBhoCbGYiIDIzOTJhYTBmMTNmZDk0Y2ZkNmE0MDA3NDExOTRiMTI0; ssid_ucp_sso_v1=1.0.0-KDRiY2EzOTI1NzUwNjE5MDJkZWRiNzdlMTVhMmE2M2EyNzRmNzgxOTcKIQi8rrCOmPW7BhCv4P20BhjvMSAMMI7P4PwFOAZA9AdIBhoCbGYiIDIzOTJhYTBmMTNmZDk0Y2ZkNmE0MDA3NDExOTRiMTI0; passport_auth_status=ca44f630c22f2494ace62e1c6958c872%2C; passport_auth_status_ss=ca44f630c22f2494ace62e1c6958c872%2C; uid_tt=a2fe779235026d3f15e75365b03804a7; uid_tt_ss=a2fe779235026d3f15e75365b03804a7; sid_tt=7f45e9be30d5f60ddb564602657c9861; sessionid=7f45e9be30d5f60ddb564602657c9861; sessionid_ss=7f45e9be30d5f60ddb564602657c9861; UIFID=3c3e9d4a635845249e00419877a3730e2149197a63ddb1d8525033ea2b3354c273f5d75f318fa0a390dc6408015441d82aa49c2d66d1bb43f586ab28e990153b6f6a8e9565bbcf8a77800aa630fb5c49d170ed1bd3d3aae131da0f372c7f55b0bbca2d56aed7f3c6f9224550bbe64cf8ae15db1acc9fc4b4d36ac427f6c76ef8d829d685d521d324889962d55cd645378569d94a6a0330af06dd17deaeaa9d8a; IsDouyinActive=true; FOLLOW_LIVE_POINT_INFO=%22MS4wLjABAAAA1qm6PX470VDbocs0oRhHRKGxN9SV68WSX6gTb_AarFyuJSZIzvnELd64PfeReQiv%2F1721750400000%2F0%2F1721724980610%2F0%22; home_can_add_dy_2_desktop=%221%22; passport_fe_beating_status=true; _bd_ticket_crypt_doamin=2; _bd_ticket_crypt_cookie=498c8e38c2a6efbbf6b28ee5d2e4b6a5; __security_server_data_status=1; bd_ticket_guard_client_data=eyJiZC10aWNrZXQtZ3VhcmQtdmVyc2lvbiI6MiwiYmQtdGlja2V0LWd1YXJkLWl0ZXJhdGlvbi12ZXJzaW9uIjoxLCJiZC10aWNrZXQtZ3VhcmQtcmVlLXB1YmxpYy1rZXkiOiJCTWVjTyttTGtkMzRNc2UxT3JRcDNLZEErN1gyT3BiTDRPa1BiREt0a3N3V0ZMM1VadERHYmhUTkJxOTNuam85UllDOEdUZjNrNlUwOUtDMHA4TlVhQU09IiwiYmQtdGlja2V0LWd1YXJkLXdlYi12ZXJzaW9uIjoxfQ%3D%3D; sid_guard=7f45e9be30d5f60ddb564602657c9861%7C1721724981%7C5183997%7CSat%2C+21-Sep-2024+08%3A56%3A18+GMT; sid_ucp_v1=1.0.0-KDE3MTUxMDg5ZGFkMzczNDliMzViOGMyMzYyZjAyMGNmOGVlMTIzZWMKGwi8rrCOmPW7BhC14P20BhjvMSAMOAZA9AdIBBoCaGwiIDdmNDVlOWJlMzBkNWY2MGRkYjU2NDYwMjY1N2M5ODYx; ssid_ucp_v1=1.0.0-KDE3MTUxMDg5ZGFkMzczNDliMzViOGMyMzYyZjAyMGNmOGVlMTIzZWMKGwi8rrCOmPW7BhC14P20BhjvMSAMOAZA9AdIBBoCaGwiIDdmNDVlOWJlMzBkNWY2MGRkYjU2NDYwMjY1N2M5ODYx; biz_trace_id=e36b4b80; store-region=cn-hn; store-region-src=uid; publish_badge_show_info=%220%2C0%2C0%2C1721724986463%22; odin_tt=cb26b7f5ccac8a2bb9ab146810fb2c2fca62cc7f728f6895d65747381c2f6bbd37c4121f0f124859969c1f99594401d8; download_guide=%221%2F20240723%2F0%22'
        }

        self.js = execjs.compile(open("1111.js", encoding="utf-8").read())
    def get_video(self):
        params = "offset=0&channel_id=94349549395&max_behot_time=0&category=pc_profile_channel&disable_raw_data=true&aid=24&app_name=toutiao_web&msToken=kLTKdvJVlD0ic46bCg2UWm6yPYuHU1gqIsJAGeofYoqCX2nHpCvoQ1qAAki8maAIfUgjBxG0EeB9fOxdMrDgUIJ8U7GpGO2tmOinaSZQoqHcHTPxDL2O7o7U4K73mfk%3D"
        ab = self.js.call("aa", params)
        print(ab)
        url = self.url_api + "?" + params + '&a_bogus=' + ab
        # print(url)
        response = requests.get(url, headers=self.headers).json()
        print(response)
        for item in response['aweme_list']:
            items = {}
            items['nickname'] = item['author']['nickname']
            items['video_url'] = item['video']['play_addr']['url_list'][0]
            items['video_title'] = item['preview_title'].split("#")[0]
            print(items)
    def main(self):
        self.get_video()



if __name__ == '__main__':
    dy = Dy_vido()
    dy.main()
```







# 补环境进阶



### 一.原型和原型链

#### 1. `js`类继承

- `js`创建类的关键字class, 通过`constructor`来进行初始化参数类似于python的`init`
- 需要继承类的话使用的关键字是`extends`

```JavaScript

class Person{
    constructor(name) {
        this.name = name
    }
    dance(){
        console.log('跳舞')
    }
}


class Student extends Person{
    constructor(name, score) {
        super(name)
        this.score = score;
    }
    introduce(){
        console.log(`我是${this.name}, 考了${this.score}`)
    }
}

var student = new Student('张三', 10)
console.log(student)
student.introduce()
student.dance()

class Teacher extends Person{
    constructor(name, subject) {
        super(name)
        this.subject = subject;
    }
    introduce(){
        console.log(`我是${this.name}, 教的${this.subject}`)
    }
}

var teacher = new Teacher('柏汌', 'python')
console.log(teacher)
teacher.introduce()
teacher.dance()
```

#### 2. `js`原型

- 实现案例

```
class Student{
    constructor(name, score) {
        this.name = name;
        this.score = score;
    }
    introduce(){
        console.log(`我是${this.name}, 考了${this.score}`)
    }
}

var student = new Student('张三', 10)
console.log(student)
student.introduce()
```

- 在当前这个案例当中,创建了一个`Student`类,里面有属性和方法,我们可以通过创建的对象访问对应的属性和方法
- 但是当我们在但是输出这个对象时会看到,对象当中是没有introduce存在的,那我们为什么可以调用到introduce方法呢
- 在我们打印对象的时候会看到除了属性以为,还有会有个`__proto__`(由于浏览器版本的不同,在新版浏览器当中你看到的可能是[[Prototype]]),我们在打开之后就能去看到里面有introduce方法,那`__proto__`就是我们所说的原型, `隐式原型`
- 在创建的类里面我们同样的可以进行操作,在`Student.prototype`,也会给我们输出一个对象,可以看到输出的这个对象,和我们刚刚输出的隐式原型是相等的,这个就是类的`显式原型`
- 最终结论:每个创建的对象都会有一个隐式原型,这个隐式原型所指向的就是创建这个对象的类的显式原型,当我们在一个对象中查找属性或者方法时,如果找不到的话,就会去到原型中去找.

![image-20250106182407065](.\image\image-20250106182407065.png)



#### 3. `js`原型链

- 讲解案例

```javascript

class Person{
    constructor(name) {
        this.name = name
    }
    drink(){
        console.log('喝水')
    }
}

class Teacher extends Person{
    constructor(name, subject) {
        super(name)
        this.subject = subject;
    }
    introduce(){
        console.log(`我是${this.name}, 教的${this.subject}`)
    }
}

var teacher = new Teacher('柏汌', 'python')
console.log(teacher)
teacher.introduce()
teacher.drink()
```

- 在继承多个类的时候,他的原型层数会比较多,那我们通过这个原型网上找的这个链路就称为`原型链`

![image-20250106182441627](.\image\image-20250106182441627.png)

- 如果说你想检验一个属性或者方法是自身所拥有的呢, 可以通过`hasOwnProperty`来检测

```JavaScript
teacher.hasOwnProperty('name') -- > true
teacher.hasOwnProperty('teach') -- > false
```

- 那么`hasOwnProperty`这个方法是重哪里来的呢?

- 在JavaScript中同样是存在一个顶层类object类, 和python的是有一致的地方, 这个`hasOwnProperty`方法就是`Object`原型当中的



### 二.原型检测

官网:https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor

**`Object.getOwnPropertyDescriptor()`** 方法返回指定对象上一个自有属性对应的属性描述符。（自有属性指的是直接赋予该对象的属性，不需要从原型链上进行查找的属性）

```
Object.getOwnPropertyDescriptor(object, propertyname)
```

**参数列表**

| 参数           | 描述                   |
| -------------- | ---------------------- |
| object         | 必需。包含属性的对象。 |
| `propertyname` | 必需。属性的名称。     |

```javascript
// 浏览器里面执行
Object.getOwnPropertyDescriptor(navigator,'userAgent') // ---》undefined

// node环境执行
var navigator = {
    userAgent:"aaaaa"
}
Object.getOwnPropertyDescriptor(navigator,'userAgent')
```

**value**:与属性关联的值（仅限数据描述符）。

**writable**:当且仅当与属性关联的值可以更改时，为 `true`（仅限数据描述符）

**configurable**:当且仅当此属性描述符的类型可以更改且该属性可以从相应对象中删除时，为 `true`。

**enumerable**:当且仅当此属性在相应对象的属性枚举中出现时，为 `true`。

#### 1. 补属性

- 第1种方式,直接通过navigator来补他的隐式原型

```

navigator = {}
navigator.__proto__.userAgent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'

console.log(navigator.userAgent);
console.log(Object.getOwnPropertyDescriptor(navigator, 'userAgent'));
```

- 第二种, 通过navigator创建的类来补显式原型

```
var Navigator = function() {};
Navigator.prototype = {"userAgent": "123123123"};
navigator = new Navigator();
console.log(navigator.userAgent)
console.log(Object.getOwnPropertyDescriptor(navigator, 'userAgent'));
```

#### 2. 补方法

- 之前的操作

```
document = {}
document.createElement = function (){}
// createElement方法在document前两级的对象当中
Object.getOwnPropertyDescriptor(document.__proto__.__proto__, 'createElement')
```

- 通过原型来补

```JavaScript
Document = function Document(){}
// Object.defineProperty 直接在一个对象上定义一个新属性，或修改其现有属性，并返回此对象。
Object.defineProperty(Document.prototype,'createElement',{
    configurable: true,
    enumerable: true,
    value: function createElement(){},
    writable: true,
})
HTMLDocument = function HTMLDocument(){}
//可以将一个指定对象的原型（即内部的隐式原型属性）设置为另一个对象
Object.setPrototypeOf(HTMLDocument.prototype,Document.prototype)
document = new HTMLDocument()

console.log(Object.getOwnPropertyDescriptor(document.__proto__.__proto__, 'createElement'));
```

#### 3. `toString`检测

在 JavaScript 中，`toString()` 是一个内置函数，用于将一个值转换为字符串。

`toString()` 方法可以应用于大部分 JavaScript 值类型，包括数字、布尔值、对象、数组等。它的返回值是表示该值的字符串。

```
document.createElement.toString()
```

正常我们补环境

```javascript
document = {}
document.createElement = function(){}
// document.createElement.toString();

// 网页上输出 function createElement() { [native code] }
document.createElement.toString =function(){
    return 'function createElement() { [native code] }'
}
```



### 三. 脱环境框架学习- `vm2`

#### 1. 简介

##### 1. `vm2`

`vm2` 是` Node.js` 中的一个模块，它提供了一种在一个沙箱环境中执行 JavaScript 代码的方式。沙箱环境允许你在一个相对安全的环境中运行不信任的代码，防止恶意代码对系统的损害。`vm2` 的主要作用是创建和管理这样的沙箱环境。

##### 2. 沙箱

沙箱是一种安全机制，用于在计算机系统中隔离和限制程序或代码的执行环境，以防止对系统的不良影响。有点类似于python的虚拟环境,要是虚拟环境崩溃不会影响到真实环境,

简而言之，`vm`提供了一个干净的独立环境，提供测试, 帮助我们打造一个真实的浏览器环境.

在`Nodejs`中，我们可以通过引入`vm`模块来创建一个“沙箱”，但其实这个`vm`模块的隔离功能并不完善，还有很多缺陷，因此Node后续升级了`vm`，也就是现在的`vm2`沙箱，`vm2`引用了`vm`模块的功能，并在其基础上做了一些优化。



安装命令

```
npm install vm2
```

示例：我们只需要实例化之后调用 `run` 方法即可运行一段脚本。

```
const {VM, VMScript} = require("vm2");

const script = new VMScript("let a = 2;a");

let vm = new VM();

console.log(vm.run(script));

```

![](.\image\202304122323059.png)

#### 2.补环境框架搭建

##### 1. 大致过程

- 搭建框架可以分为3部分大的内容
  - 需要加载的环境,一般是存放在`evn`文件当中
  - 需要补环境的代码
  - `vm2`加载全部文件到沙箱环境

![image-20250106182545708](.\image\image-20250106182545708.png)

##### 2. 实战小案例

- 需要判断环境的代码

```javascript
function main(){
    var toString = Object.prototype.toString;
    if (toString.apply(document.createElement).indexOf('native code') ) {
        // 检测描述符
        var descriptor = Object.getOwnPropertyDescriptor(document.__proto__.__proto__, 'createElement');
        if(descriptor && descriptor.writable && descriptor.configurable && descriptor.enumerable) {
             return '环境通过'
          }else {
            return '描述符环境失败'
        }
    }else {
        return 'toString环境失败'
    }
}

main()

```

- 主文件运行的代码

```javascript
// 砂箱的目的就是想使用node环境 又不想被网站检测
const {VM,VMScript} = require('vm2');
const vm = new VM();
const fs = require('fs')
const {read} = require('./env/main')  // 环境相关的代码
const {readJsCode} = require('./JsCode/main')  // 需要操作的JS代码

let jscode = "";

jscode += read()
jscode += readJsCode()

const script = new VMScript(jscode, {filename: '/myvmscript.js'});
console.log(vm.run(script));
```

- 补的`createElement`环境代码

```javascript
Document = function Document(){}
// Object.defineProperty 直接在一个对象上定义一个新属性，或修改其现有属性，并返回此对象。
Object.defineProperty(Document.prototype,'createElement',{
    configurable: true,
    enumerable: true,
    value: function createElement(){},
    writable: true,
})
HTMLDocument = function HTMLDocument(){}
//可以将一个指定对象的原型（即内部的隐式原型属性）设置为另一个对象
Object.setPrototypeOf(HTMLDocument.prototype,Document.prototype)
document = new HTMLDocument()
```

##### 3.环境怎么正常拿下来

- 这里我们是直接用的之前的代码,实际上我们是要用浏览器的生成`createElement`js源代码才行
- 我们需要把这些环境一个个的重浏览器把他拖下来,可以通过`dir`的方式一个个去找,需要需要的全部`js`代码都拿过来

![image-20250106182650775](.\image\image-20250106182650775.png)

- 也能在chrome源码中去找到这些文件
- 地址:https://github.com/chromium/chromium

![image-20250106182728249](.\image\image-20250106182728249.png)

- 总额言之,要他的源代码信息要拿下来可以说是非常麻烦的,我们没有必要去硬扣,太耽误时间了,也不是我们要考虑的问题,
- 可以直接在`github`找别人已经写好的现成框架代码,我们没有必要去搞这些

![image-20250106182809594](.\image\image-20250106182809594.png)

- 这些现成的框架已经帮我们把所有的环境都拿下来了,可以直接用



### 四.框架使用

- 夏洛老师有整理出来一个封装好的框架,大家可以直接拿过来用就好了

![image-20250106182834184](.\image\image-20250106182834184.png)

- 环境文件都在`env`当中
- 我们需要把需要执行的`js`代码放在run文件当中
- 主执行文件是`main.js`

#### 1.参数导出

```javascript

var express = require('express')
var app = express()
function ths(){
    const { VM, VMScript } = require("vm2")
    const vm = new VM();
    vm.setGlobal('bofs', fs)
    vm.setGlobal('bobo$',bobo$)
    // debugger
    vm.setGlobal('bobocheerio',cheerio)
    vm.setGlobal('bocreateCanvas',createCanvas)
    const codeTest=`${configCode}${log_code}${toolsCode}${envCode}${globadlThis}${globalInit}${userInit}${proxyObj};;${jscode}${asyncCode};console.table(myloglist);debugger;${last_deal}`
    const script = new VMScript(codeTest, "./debugJS.js")
    const result = vm.run(script);
    return result
    // console.log(result)
    // fs.writeFileSync(`${run_path}/output.js`,codeTest)
}

// ths()
app.get('/', function (req, res){
        data = req.query.data
    console.log(data)
    res.send(ths())
})

app.listen(3000, function (){
    console.log('启动')
})


```

